<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –°–æ—Ü—Å–µ—Ç—å</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #f0f2f5; }
        #app { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { background: white; border-radius: 0 0 12px 12px; padding: 15px 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        .avatar-large { width: 100px; height: 100px; border-radius: 50%; background: #1877f2; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 42px; overflow: hidden; }
        .avatar-large img { width: 100%; height: 100%; object-fit: cover; }
        
        .profile-info { flex: 1; }
        .profile-info h1 { font-size: 24px; margin-bottom: 5px; }
        .profile-info p { color: #65676b; }
        
        .stats { display: flex; gap: 30px; margin-top: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: #1c1e21; }
        .stat-label { color: #65676b; font-size: 14px; }
        
        .post { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #1877f2; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .avatar.small { width: 30px; height: 30px; font-size: 14px; }
        
        .post-author { font-weight: 600; color: #1c1e21; text-decoration: none; }
        .post-time { font-size: 12px; color: #65676b; }
        .post-content { margin: 12px 0; white-space: pre-wrap; }
        .post-image { max-width: 100%; border-radius: 12px; margin: 12px 0; }
        
        .post-actions { display: flex; gap: 20px; border-top: 1px solid #ddd; padding-top: 12px; margin-top: 12px; }
        .action-btn { background: none; border: none; color: #65676b; cursor: pointer; padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; }
        .action-btn:hover { background: #f0f2f5; }
        .action-btn.active { color: #1877f2; }
        
        .comment-box { margin-top: 15px; padding-left: 20px; border-left: 3px solid #1877f2; }
        .comment { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .comment-author { font-weight: 600; color: #1877f2; text-decoration: none; }
        
        .nav-links { display: flex; gap: 10px; }
        .nav-btn { background: #e4e6eb; color: #1c1e21; padding: 8px 16px; border-radius: 20px; text-decoration: none; }
        .nav-btn:hover { background: #d8dadf; }
        
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; color: #65676b; }
        .error-message { color: #dc3545; text-align: center; padding: 40px; }
        .back-link { margin-bottom: 20px; display: inline-block; color: #1877f2; text-decoration: none; }
        
        .subscribe-btn { background: #42b72a; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .subscribe-btn:hover { background: #36a420; }
        .subscribe-btn.subscribed { background: #e4e6eb; color: #1c1e21; }
        
        .followers-section { margin-top: 20px; }
        .followers-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        .follower-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; }
        .follower-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="app">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header" id="mainHeader">
            <div class="nav-links">
                <a href="index.html" class="nav-btn">üè† –õ–µ–Ω—Ç–∞</a>
                <a href="#" id="profileLinkBtn" class="nav-btn hidden">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
            </div>
            <div>
                <span id="userEmail"></span>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="card" id="profileContent">
            <a href="index.html" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–µ–Ω—Ç—É</a>
            <div id="profileInfo"></div>
            <div id="subscribeButton"></div>
            
            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–æ–∫ -->
            <div class="followers-section" id="followersSection" style="margin-top: 20px;">
                <h4>–ü–æ–¥–ø–∏—Å–∫–∏</h4>
                <div id="followingList" class="followers-list"></div>
                
                <h4 style="margin-top: 15px;">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</h4>
                <div id="followersList" class="followers-list"></div>
            </div>
        </div>

        <!-- –ü–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="userPosts"></div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏/–æ—à–∏–±–∫–∏ -->
        <div id="loadingState" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>
        <div id="errorState" class="error-message hidden"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCOwAvJ9bH2eeD8wcM4bK_83IEAH9o_HtE",
            authDomain: "zorokuboch.firebaseapp.com",
            databaseURL: "https://zorokuboch-default-rtdb.firebaseio.com",
            projectId: "zorokuboch",
            storageBucket: "zorokuboch.firebasestorage.app",
            messagingSenderId: "453409495112",
            appId: "1:453409495112:web:816b7d0ec4fc530206207d",
            measurementId: "G-2CJCQ200YT"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const profileUserId = urlParams.get('id');

        const userEmail = document.getElementById('userEmail');
        const profileLinkBtn = document.getElementById('profileLinkBtn');
        const profileInfo = document.getElementById('profileInfo');
        const subscribeButton = document.getElementById('subscribeButton');
        const followingList = document.getElementById('followingList');
        const followersList = document.getElementById('followersList');
        const userPosts = document.getElementById('userPosts');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');

        let currentUser = null;

        function getInitials(email) {
            return email ? email.substring(0, 2).toUpperCase() : '?';
        }

        function renderAvatar(container, userData, size = 'small') {
            const sizeClass = size === 'large' ? 'large' : (size === 'small' ? 'small' : '');
            if (userData && userData.avatar) {
                container.innerHTML = `<img src="${userData.avatar}" alt="Avatar">`;
            } else {
                container.textContent = getInitials(userData?.email || userData?.author || '?');
                container.style.background = '#1877f2';
                container.style.color = 'white';
            }
            container.className = `avatar ${sizeClass}`;
        }

        async function loadUserData(userId) {
            const snapshot = await database.ref(`users/${userId}`).once('value');
            return snapshot.val() || {};
        }

        async function checkIfSubscribed(currentUserId, targetUserId) {
            if (!currentUserId) return false;
            const snapshot = await database.ref(`followers/${currentUserId}/${targetUserId}`).once('value');
            return snapshot.exists();
        }

        async function loadFollowingList(userId) {
            const snapshot = await database.ref(`followers/${userId}`).once('value');
            const following = snapshot.val() || {};
            
            followingList.innerHTML = '';
            
            if (Object.keys(following).length === 0) {
                followingList.innerHTML = '<p style="text-align: center; color: #65676b;">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</p>';
                return;
            }

            for (const [followerId] of Object.entries(following)) {
                const userData = await loadUserData(followerId);
                const div = document.createElement('div');
                div.className = 'follower-item';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar small';
                renderAvatar(avatar, userData, 'small');
                
                const name = document.createElement('span');
                name.textContent = userData.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                const link = document.createElement('a');
                link.href = `user.html?id=${followerId}`;
                link.style.marginLeft = 'auto';
                link.style.color = '#1877f2';
                link.textContent = '–ü—Ä–æ—Ñ–∏–ª—å';
                
                div.appendChild(avatar);
                div.appendChild(name);
                div.appendChild(link);
                followingList.appendChild(div);
            }
        }

        async function loadFollowersList(userId) {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö, –∫—Ç–æ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const snapshot = await database.ref('followers').once('value');
            const allFollowers = snapshot.val() || {};
            const followers = [];
            
            for (const [followerId, following] of Object.entries(allFollowers)) {
                if (following[userId]) {
                    followers.push(followerId);
                }
            }
            
            followersList.innerHTML = '';
            
            if (followers.length === 0) {
                followersList.innerHTML = '<p style="text-align: center; color: #65676b;">–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</p>';
                return;
            }

            for (const followerId of followers) {
                const userData = await loadUserData(followerId);
                const div = document.createElement('div');
                div.className = 'follower-item';
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar small';
                renderAvatar(avatar, userData, 'small');
                
                const name = document.createElement('span');
                name.textContent = userData.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                const link = document.createElement('a');
                link.href = `user.html?id=${followerId}`;
                link.style.marginLeft = 'auto';
                link.style.color = '#1877f2';
                link.textContent = '–ü—Ä–æ—Ñ–∏–ª—å';
                
                div.appendChild(avatar);
                div.appendChild(name);
                div.appendChild(link);
                followersList.appendChild(div);
            }
        }

        if (!profileUserId) {
            errorState.textContent = 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω';
            errorState.classList.remove('hidden');
            loadingState.classList.add('hidden');
        }

        auth.onAuthStateChanged(user => {
            currentUser = user;
            
            if (user) {
                userEmail.textContent = user.email;
                profileLinkBtn.href = `user.html?id=${user.uid}`;
                profileLinkBtn.classList.remove('hidden');
            } else {
                userEmail.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
            }

            if (profileUserId) {
                loadUserProfile(profileUserId);
            }
        });

        const loadUserProfile = async (userId) => {
            try {
                const postsSnapshot = await database.ref('posts').once('value');
                const posts = postsSnapshot.val() || {};
                
                const userPostsList = Object.entries(posts)
                    .map(([id, data]) => ({ id, ...data }))
                    .filter(post => post.authorId === userId)
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                const userData = await loadUserData(userId);
                const postsCount = userPostsList.length;
                const likesCount = userPostsList.reduce((sum, post) => sum + (post.likes ? Object.keys(post.likes).length : 0), 0);
                const commentsCount = userPostsList.reduce((sum, post) => sum + (post.comments ? Object.keys(post.comments).length : 0), 0);

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                profileInfo.innerHTML = `
                    <div class="profile-header">
                        <div class="avatar-large">${userData.avatar ? `<img src="${userData.avatar}" alt="Avatar">` : getInitials(userData.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</div>
                        <div class="profile-info">
                            <h1>${userData.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h1>
                            <p>ID: ${userId}</p>
                            <div class="stats">
                                <div class="stat-item">
                                    <div class="stat-value">${postsCount}</div>
                                    <div class="stat-label">–ø–æ—Å—Ç–æ–≤</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${likesCount}</div>
                                    <div class="stat-label">–ª–∞–π–∫–æ–≤</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${commentsCount}</div>
                                    <div class="stat-label">–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                if (currentUser && currentUser.uid !== userId) {
                    const isSubscribed = await checkIfSubscribed(currentUser.uid, userId);
                    subscribeButton.innerHTML = `
                        <button class="subscribe-btn ${isSubscribed ? 'subscribed' : ''}" id="toggleSubscribeBtn">
                            ${isSubscribed ? '‚úì –ü–æ–¥–ø–∏—Å–∞–Ω–æ' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}
                        </button>
                    `;
                    
                    document.getElementById('toggleSubscribeBtn').addEventListener('click', async () => {
                        const subscribed = await checkIfSubscribed(currentUser.uid, userId);
                        if (subscribed) {
                            await database.ref(`followers/${currentUser.uid}/${userId}`).remove();
                        } else {
                            await database.ref(`followers/${currentUser.uid}/${userId}`).set(true);
                        }
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
                        loadUserProfile(userId);
                    });
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
                await loadFollowingList(userId);
                await loadFollowersList(userId);

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å—Ç—ã
                if (userPostsList.length === 0) {
                    userPosts.innerHTML = '<div class="card">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</div>';
                } else {
                    userPosts.innerHTML = '<h3 style="margin-bottom: 15px;">–ü–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>' + 
                        userPostsList.map(post => renderPost(post)).join('');
                    
                    userPostsList.forEach(post => {
                        setupPostListeners(post.id);
                    });
                }

                loadingState.classList.add('hidden');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                errorState.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è';
                errorState.classList.remove('hidden');
                loadingState.classList.add('hidden');
            }
        };

        const renderPost = (post) => {
            const userLiked = currentUser && post.likes && post.likes[currentUser.uid];
            const likesCount = post.likes ? Object.keys(post.likes).length : 0;
            const commentsCount = post.comments ? Object.keys(post.comments).length : 0;

            return `
                <div class="post" data-post-id="${post.id}">
                    <div class="post-header">
                        <div class="avatar">${post.authorAvatar ? `<img src="${post.authorAvatar}" alt="Avatar">` : getInitials(post.author)}</div>
                        <div>
                            <a href="user.html?id=${post.authorId}" class="post-author">${post.author || '–ê–Ω–æ–Ω–∏–º'}</a>
                            <div class="post-time">${post.timestamp ? new Date(post.timestamp).toLocaleString() : '—Ç–æ–ª—å–∫–æ —á—Ç–æ'}</div>
                        </div>
                    </div>
                    ${post.text ? `<div class="post-content">${escapeHtml(post.text)}</div>` : ''}
                    ${post.image ? `<img src="${post.image}" class="post-image" alt="Post image">` : ''}
                    <div class="post-actions">
                        <button class="action-btn like-btn ${userLiked ? 'active' : ''}" data-post-id="${post.id}">
                            ${userLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span>${likesCount}</span>
                        </button>
                        <button class="action-btn comment-toggle-btn" data-post-id="${post.id}">
                            üí¨ <span>${commentsCount}</span>
                        </button>
                    </div>
                    <div class="comment-box hidden" id="comments-${post.id}">
                        <div class="comments-list" id="comments-list-${post.id}">
                            ${renderComments(post.comments)}
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" id="comment-input-${post.id}" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="flex: 1;">
                            <button class="action-btn add-comment-btn" data-post-id="${post.id}" style="width: auto;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderComments = (comments) => {
            if (!comments) return '';
            return Object.entries(comments).map(([id, comment]) => `
                <div class="comment">
                    <a href="user.html?id=${comment.authorId}" class="comment-author">${comment.author || '–ê–Ω–æ–Ω–∏–º'}</a>
                    <span>${escapeHtml(comment.text)}</span>
                </div>
            `).join('');
        };

        const setupPostListeners = (postId) => {
            const likeBtn = document.querySelector(`.like-btn[data-post-id="${postId}"]`);
            if (likeBtn) {
                likeBtn.addEventListener('click', () => handleLike(postId));
            }

            const commentToggle = document.querySelector(`.comment-toggle-btn[data-post-id="${postId}"]`);
            if (commentToggle) {
                commentToggle.addEventListener('click', () => {
                    const commentBox = document.getElementById(`comments-${postId}`);
                    commentBox.classList.toggle('hidden');
                });
            }

            const addCommentBtn = document.querySelector(`.add-comment-btn[data-post-id="${postId}"]`);
            if (addCommentBtn) {
                addCommentBtn.addEventListener('click', () => {
                    const input = document.getElementById(`comment-input-${postId}`);
                    const text = input.value.trim();
                    if (text && currentUser) {
                        handleAddComment(postId, text);
                        input.value = '';
                    }
                });
            }
        };

        const handleLike = async (postId) => {
            if (!currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏');
                return;
            }
            
            const postRef = database.ref(`posts/${postId}/likes/${currentUser.uid}`);
            const snapshot = await postRef.once('value');
            
            if (snapshot.exists()) {
                await postRef.remove();
            } else {
                await postRef.set(true);
            }
        };

        const handleAddComment = async (postId, text) => {
            if (!currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å');
                return;
            }

            const newComment = {
                author: currentUser.email,
                authorId: currentUser.uid,
                text: text,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            await database.ref(`posts/${postId}/comments`).push(newComment);
        };

        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
    </script>
</body>
</html>